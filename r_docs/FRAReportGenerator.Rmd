---
title: "FR+A Report Generator"
output: 
  word_document:
    reference_docx: data/fra-template.docx
date: "2023-12-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(magrittr)
library(officer)
library(officedown)
library(dplyr)
source("../r_docs/R/styles.R")
source("../r_docs/R/grammar.R")
source("../r_docs/R/variables.R")
source("../r_docs/R/elements/header.R")
#source("../r_docs/R/elements/heading.R")
source("../r_docs/R/elements/qualifications.R")
source("../r_docs/R/elements/receipt.R")
# table for reading styles
styles_tab <- styles_info(doc)
```

```{r header replacement code}
# replace header texts
doc <- read_docx(ifelse(doc_type == "notes", "../data/fra-template-notes.dotx", "../data/fra-template-caus-rebut.dotx"))
headers_replace_all_text(x = doc, old_value = "Line1", new_value = paste0(lawyer$first_name, " ", lawyer$last_name, ", Esquire"), warn = FALSE)
headers_replace_all_text(x = doc, old_value = "Line2", new_value = "Attorney at Law", warn = FALSE)
headers_replace_all_text(x = doc, old_value = "Line3", new_value = case_name, warn = FALSE)
headers_replace_all_text(x = doc, old_value = "ddd_date", new_value = convert_date_format(ddd), warn = FALSE)
```


```{r loop fpar add function}
block_add_fun <- function(x, blocklist, style = "Normal") {
  if (length(blocklist) == 0) {
    # If blocklist is empty, return x without further action
    return(x)
  }
  for (i in length(blocklist):1) {
    body_add(x, blocklist[[i]], style = style)
  }
  return(x)
}
```

```{r heading}
heading <- list()

if (doc_type != "notes") {
  heading <- list(
    fpar(
      ftext(
        convert_date_format(
          ddd
        ))),
    fpar(),
    fpar(
      ftext(
        paste(
          lawyer$first_name, 
          lawyer$last_name, 
          "Esquire"
        ))),
    fpar(
      ftext(
        lawyer$firm_name
      )),
    fpar(
      ftext(
        lawyer$address
      )),
    fpar(
      ftext(
        paste0(
          lawyer$city,
          ", ",
          lawyer$state,
          " ",
          lawyer$zip
        ))),
    fpar(),
    fpar(
      ftext(
        paste0(
          "Tel: ",
          phone_fun(
            lawyer$phone
          )))),
    fpar(),
    fpar()
  )
}

heading <- c(heading, list(
  fpar(
    ftext(
      paste0(
        "RE:\t")),
    ftext(case_name, fp_text_lite(italic = TRUE))
  ),
  fpar(),
  fpar(),
  fpar(
    ftext(
      paste0(
        "Date of Crash:\t", 
        convert_date_format(
          crash$date
        ))))))

for (i in 1:length(plaintiff$first_name)) {
  heading <- c(heading,
               list(fpar(
                 ftext(
                   ifelse(i == 1, "Date of Birth:\t", "\t")),
                 ftext(paste0(
                   plaintiff$first_name[i],
                   " ",
                   plaintiff$last_name[i],
                   ": "),
                   prop = fp_text_lite(italic = TRUE)),
                 ftext(
                   convert_date_format(
                     plaintiff$dob[i]
                   )), 
                 ftext(" ["), ftext(plaintiff$age[i]), 
                 ftext(" years old at time of crash]")))
  )
}

heading <- c(heading, list(fpar(), fpar()))
```

```{r receipt}
receipt <- list(
  fpar(
    ftext(
      paste("Dear", Mr_Ms_Lastname(lawyer))
    ),
    ftext(",")
  ),
  fpar(),
  fpar(
    ftext(
      "I am in receipt of your correspondence regarding the above-named "),
    ftext(
      if (case == "yes") {
        "action"
      } else if (length(plaintiff$first_name) > 1) {
        "individuals"
      } else {
        "individual"
      }),
    ftext(
      ". I have reviewed the documentation accompanying your correspondence including medical records, information regarding the subject crash, litigation documents, and other materials"
    ),
    if (doc_type == "causation")
      ftext(
        "."
      ) else if (doc_type == "rebuttal") {
        ftext(
          paste0(
            ", including the ",
            if(defense_biomech_expert$depo_reviewed == "yes")
              paste0(
                convert_date_format(defense_biomech_expert$depo_date), 
                ", deposition transcript and the "),
            convert_date_format(defense_biomech_expert$report_date), 
            ", report from the defendant's crash reconstruction and biomechanical expert, ",
            defense_biomech_expert$title,
            " ",
            defense_biomech_expert$first_name,
            " ",
            defense_biomech_expert$last_name,
            "."
          ))}),
  fpar())
```

```{r purpose}
purpose <- list()
purpose$causation$rollover$part1 <- list(
  fpar(
    ftext(
      paste0(
        "The purpose of this report is to provide an opinion regarding the causal relationship between the degree of roof crush observed in the subject ", plaintiff$car_make, " ", plaintiff$car_model, " and the severe spine and spinal cord injuries sustained by ", Mr_Ms_Lastname(), " in the ", convert_date_format(crash$date), ", rollover crash. Specifically, my opinions address the theory of occupant \"diving\" in rollover crashes as the cause of serious head and neck injury, versus excessive roof crush. The methods and conclusions described in this report are largely based on peer-reviewed published research that I supervised and co-authored, specifically:"
      )
    )
    
  ),
  fpar()
)

purpose$causation$rollover$publications <- list(
  fpar(
    ftext(
      "Dobbertin KM, Freeman MD, Lambert WE, Lasarev MR, Kohles SS. The relationship between vehicle roof crush and head, neck and spine injury in rollover crashes. Accid Anal Prev 2013;58:46-52"
    )
  ),
  fpar(
    ftext(
      "Freeman MD, Dobbertin K, Kohles SS, Uhrenholt L, Eriksson A. Serious head and neck injury as a predictor of occupant position in fatal rollover crashes. Forensic Sci Int 2012;222:228–33."
    )
  ),
  fpar()
)

purpose$causation$rollover$part2 <- list(
  fpar(
    ftext(
      paste("The conclusions of the investigation described herein, as they apply to", Mr_Ms_Lastname(), "'s injuries and the subject crash, are described beginning on page 41 of this report.")
    )
  ),
  fpar()
)

purpose$causation$general <- list(
  fpar(
    ftext(
      paste0("The purpose of this report is to provide an analysis of the causal relationship between the subject ", crash$pdof, " impact collision and ", Mr_Ms_Lastname(), "’s subsequently diagnosed ", plaintiff$injury_location[1], " injuries and need for treatment.")
    )
  ),
  fpar()
)

purpose$rebuttal <- list(
  fpar(
    ftext(
      paste0("The purpose of this report is to assess the methods and conclusions of ", Dr_Mr_Ms_Expert_Lastname(), " as they pertain to the injury potential of the subject collision, relative to ", Mr_Ms_Lastname(), "’s post-crash diagnoses and treatment.)"
      )
    )
  ),
  fpar(),
  fpar(
    ftext(
      "My summary opinions in this matter are as follows:", fp_text_lite(bold = TRUE) 
    )
  )
)
```

```{r summary opinions}
# for rebuttal only

summary_opinions <- list(
  fpar(
    ftext(
      paste0(
        Dr_Mr_Ms_Expert_Lastname(), "'s assertion that the subject collision did not have the capacity to cause or exacerbate any of the injuries indisputably diagnosed in ", Mr_Ms_Lastname(), "are lacking a foundation in science, medicine, or the facts in this case. ", Dr_Mr_Ms_Expert_Lastname(), "'s opinions are based on a confusing and disingenuous presentation of a novel and distorted approach to causality and a misrepresentation and misuse of published literature."
      ), fp_text_lite(bold = TRUE)),
    run_linebreak()),
  fpar(
    ftext(
      paste0(
        Dr_Mr_Ms_Expert_Lastname(), "'s assertion that the subject crash only produced minimal and benign forces that could not have cause ", Mr_Ms_Lastname(), "'s diagnosed spinal disk and other injuries because the forces in the collision were supposedly equal to those of ordinary and benign forces is not a reliable, relevant, or validated method of assessing injury cause. Using ", Dr_Mr_Ms_Expert_Lastname(), "'s claimed delta V of ", defense_biomech_expert$deltaV, " mph for the subject collision indicates significant occupant motion and forces that in no way resemble any of the absurdly innocuous comparisons claimed by ", Dr_Mr_Ms_Expert_Lastname(), ". Such comparisons are demonstrably unscientific and highly misleading, and irrelevant to any disputed issues in ", Mr_Ms_Lastname(), "'s case."
      ), fp_text_lite(bold = TRUE)),
    run_linebreak()),
  fpar(
    ftext(
      paste0(
        "There is no scientific or factual basis for ", Dr_Mr_Ms_Expert_Lastname(), "'s claim that ", Mr_Ms_Lastname(), "'s previous spinal injuries could not or should not have been \"exacerbated\" by the subject crash. Indeed, ", Dr_Mr_Ms_Expert_Lastname(), "'s use of the term is both meaningless and misleading, and neither ", he_she(defense_biomech_expert$gender), " nor anyone else has the faintest idea of what forces would have been required to have caused ", Mr_Ms_Lastname(), "'s previously diagnosed spinal disk and other injuries to become symptomatic, or to worsen. To suggest otherwise is frankly dishonest."
      ), fp_text_lite(bold = TRUE)
    ),
    run_linebreak()
  ),
  fpar(
    ftext(
      paste0(
        "The methodology and principles used by ", Dr_Mr_Ms_Expert_Lastname(), " to arrive at ", his_her(defense_biomech_expert$gender), " opinions regarding the risk of injury from the crash to ", Mr_Ms_Lastname(), " are not scientifically reliable, either in general or as they were applied to the facts of this case. Despite a superficial appearance of scientific validity, ", Dr_Mr_Ms_Expert_Lastname(), "'s methods are speculative, unscientific, and unreliable, and ", his_her(defense_biomech_expert$gender), " conclusions are meaningless."
      ), fp_text_lite(bold = TRUE)
    ),
    run_linebreak(),
    run_linebreak()
  )
)

```

```{r qualifications}
qualifications <- list()
qualifications$causation <- list(
  fpar(
    ftext(
      "My qualifications to provide opinions concerning the matters herein, particularly on issues of the causal relationship between trauma and injury, are as follows:",
      prop = fp_text_lite(italic = TRUE))),
  fpar(),
  fpar(
    ftext(
      "I am Professor and Chair of Forensic and Legal Medicine with the Faculty of Forensic and Legal Medicine of the Royal College of Physicians (UK), and a consultant in the fields of forensic medicine and forensic epidemiology. I am credentialed as a Fellow of the Royal College of Pathologists (UK), Fellow of the Faculty of Forensic and Legal Medicine (FFLM) of the Royal College of Physicians (UK) and member of the British Association in Forensic Medicine. I hold the following relevant academic degrees and certifications: a Doctor of Medicine degree (Med.Dr.) from Umeå University, a Doctor of Philosophy (Ph.D.) in public health/epidemiology from Oregon State University, a Master of Public Health (MPH) in epidemiology and biostatistics, also from Oregon State University, a master’s degree in forensic medical sciences (MScFMS) with the Academy of Forensic Medical Sciences in the United Kingdom, i.a. In addition to my degreed education, I have completed a 2-year post-doctoral fellowship in forensic pathology at Umeå University in Sweden and hold a Diploma of Legal Medicine (DLM) with the FFLM. I am also a fellow of both the American Academy of Forensic Sciences and the American College of Epidemiology. I am a Fulbright Fellow and held a 3-year roster appointment (2017-20) with the United States Department of State as a Fulbright Specialist in the field of forensic medicine. I serve as tenured Associate Professor of Forensic Medicine at Maastricht University and a joint Clinical Professor of Psychiatry and Public Health and Preventative Medicine at Oregon Health and Science University School of Medicine, where I have taught courses for the past 24 years in forensic medicine, forensic epidemiology, and injury epidemiology. From 2005-2017 I held an appointment as an Adjunct Professor of Forensic Medicine and Epidemiology at the Institute of Forensic Medicine, Faculty of Health Sciences, Aarhus University, Aarhus, Denmark, and am a recent (2020-21) visiting professor at University of Indonesia in the Faculty of Medicine."
    )),
  fpar(),
  fpar(
    ftext(
      "I have been a crash reconstructionist since 1996 and have had ACTAR accreditation (the Accreditation Commission on Traffic Accident Reconstruction) since 2005. Over the past >25 years I have participated in the reconstruction of more than 3,000 crashes, including more than 300 fatalities. From 1999 through 2007 I served as a vehicular homicide investigator for law enforcement (consultant to the state medical examiner and special deputy sheriff), and I am a former affiliate medical examiner with the Allegheny County Medical Examiner’s office."
    )),
  fpar(),
  fpar(
    ftext(
      "I am a member of the American Society of Biomechanics and have more than 60 scientific publications pertaining to injury biomechanics, including a book for the Society of Automotive Engineering and taught injury biomechanics in a faculty peer-reviewed course at OHSU for 15 years. I have served as a consultant on injury biomechanics to state and federal government."
    )),
  fpar(),
  fpar(
    ftext(
      "I am an associate editor of the Journal of Forensic and Legal Medicine and serve or have served as an associate editor or editorial board member of 14 additional scientific peer-reviewed journals. I have published approximately 230 scientific papers, abstracts, book chapters and books on topics that include traffic crash injuries, crash reconstruction, injury causation and injury biomechanics, including the text for Elsevier, Forensic Epidemiology: Principles and Practice (2016). My publications have been cited by other authors more than 4,700 times."
    )),
  fpar(),
  fpar(
    ftext(
      "I have provided testimony in more than 400 civil and criminal trials in state and Federal courts throughout the United States, Canada, and Australia. Please see my CV for further details."
    ),
    run_pagebreak()
  )
)
```

```{r background facts and med hx}
background_facts <- list()

background_facts$notes <- list(
  block_pour_docx(background_facts_recon_file_name),
  block_pour_docx(med_hx_file_name)
)

background_facts$causation <- list(
  block_pour_docx(background_facts_recon_file_name),
  fpar(
    ftext(
    "At the time of the crash, "
  )),
  block_pour_docx(med_hx_file_name)
)

background_facts$rebuttal <- list(
  block_pour_docx(background_facts_recon_file_name),
  fpar(
    ftext(
    "At the time of the crash, "
  )),
  block_pour_docx(med_hx_file_name)
)
```



```{r report structure build}
notes_structure <- as.list(
  c(heading,
  background_facts$notes))
```

```{r heading loop function call}
# style = "Normal": at least 16 pt line spacing; majority doc style
# style = "Body Text 2": Single line spacing and 3.75 tab distance
# style = "Author": block quote style indentation on both sides
# style = "Definition": bullet point

doc %>%
  cursor_begin() %>% 
  body_remove() %>%
  # report section order has to be backwards because of how body_add() function works
  # block_add_fun(background_facts$notes) %>%
  # block_add_fun(qualifications$causation, style = "Normal") %>%
  # block_add_fun(summary_opinions, style = "Definition") %>%
  # block_add_fun(purpose$rebuttal, style = "Normal") %>%
  # block_add_fun(purpose$causation$general, style = "Normal") %>%
  # block_add_fun(purpose$causation$rollover$part2, style = "Normal") %>%
  # block_add_fun(purpose$causation$rollover$publications, style = "Author") %>%
  # block_add_fun(purpose$causation$rollover$part1, style = "Normal") %>%
  # block_add_fun(receipt) %>%
  # block_add_fun(heading, style = "Body Text 2") %>%
  # body_add(block_pour_docx(background_facts_recon_file_name)) %>%
  # block_add_fun(notes_structure) %>%
  print(target = "../FRA-report-output.docx")
```

```{r sample footnote}
# working footnote structure
bl <- block_list(
  fpar(ftext(" hello"), fp_p = fp_par_footnote), 
  fpar(ftext(" second ref"), fp_p = fp_par_footnote),
  fpar(ftext(" second ref"), fp_p = fp_par_footnote)
)

footnote_fpar <- fpar(
  "this paragraph contains a note",
  run_footnote(x = bl[1], prop = fp_text_refnote),
  run_footnote(x = bl[2], prop = fp_text_refnote),
  run_footnote(x = bl[3], prop = fp_text_refnote),
  "."
)
```


```{r test remove}
# library(officer)
# 
# str1 <- rep("Lorem ipsum dolor sit amet, consectetur adipiscing elit. ", 20)
# str1 <- paste(str1, collapse = "")
# 
# str2 <- "Drop that text"
# 
# str3 <- rep("Aenean venenatis varius elit et fermentum vivamus vehicula. ", 20)
# str3 <- paste(str3, collapse = "")
# 
# my_doc <- read_docx()
# my_doc <- body_add_par(my_doc, value = str1, style = "Normal")
# my_doc <- body_add_par(my_doc, value = str2, style = "centered")
# my_doc <- body_add_par(my_doc, value = str3, style = "Normal")
# 
# new_doc_file <- print(my_doc, target = "one.docx")
# 
# my_doc <- read_docx(path = new_doc_file)
# my_doc <- cursor_reach(my_doc, keyword = "that text")
# my_doc <- body_remove(my_doc)
# 
# print(my_doc, target = "two.docx")
```


```{r final build}
# Heading

# Lawyer address

# Intro paragraph

# The Purpose of this Report

# Summary Opinions (rebuttal)

# Qualifications

# Background Facts

# Medical History

# General Comments on Expert (rebuttal)

# Injury Biomechanics intro

# Injury Biomechanics body

# 3 steps alternative explanations (Causation)

# Rebuttal points

# Conclusions

# Signature Block

# Appendix

```
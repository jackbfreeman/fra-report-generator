---
title: "FR+A Report Generator"
output: 
  word_document:
    reference_docx: data/fra-template.docx
date: "2023-12-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(magrittr)
library(officer)
library(officedown)
library(dplyr)
source("../r_docs/R/styles.R")
source("../r_docs/R/grammar.R")
source("../r_docs/R/variables.R")
source("../r_docs/R/elements/header.R")
#source("../r_docs/R/elements/heading.R")
source("../r_docs/R/elements/qualifications.R")
source("../r_docs/R/elements/receipt.R")
# table for reading styles
styles_tab <- styles_info(doc)
```

```{r header replacement code}
# replace header texts
doc <- read_docx(ifelse(doc_type == "notes", "../data/fra-template-notes.dotx", "../data/fra-template-caus-rebut.dotx"))
headers_replace_all_text(x = doc, old_value = "Line1", new_value = paste0(lawyer$first_name, " ", lawyer$last_name, ", Esquire"), warn = FALSE)
headers_replace_all_text(x = doc, old_value = "Line2", new_value = "Attorney at Law", warn = FALSE)
headers_replace_all_text(x = doc, old_value = "Line3", new_value = case_name, warn = FALSE)
headers_replace_all_text(x = doc, old_value = "ddd_date", new_value = convert_date_format(ddd), warn = FALSE)
```


```{r loop fpar add function}
block_add_fun <- function(x, blocklist, style = "Normal") {
  if (length(blocklist) == 0) {
    # If blocklist is empty, return x without further action
    return(x)
  }
  for (i in length(blocklist):1) {
    body_add(x, blocklist[[i]], style = style)
  }
  return(x)
}
```

```{r heading}
heading <- list()

if (doc_type != "notes") {
  heading <- list(
    fpar(
      ftext(
        convert_date_format(
          ddd
        ))),
    fpar(),
    fpar(
      ftext(
        paste(
          lawyer$first_name, 
          lawyer$last_name, 
          "Esquire"
        ))),
    fpar(
      ftext(
        lawyer$firm_name
      )),
    fpar(
      ftext(
        lawyer$address
      )),
    fpar(
      ftext(
        paste0(
          lawyer$city,
          ", ",
          lawyer$state,
          " ",
          lawyer$zip
        ))),
    fpar(),
    fpar(
      ftext(
        paste0(
          "Tel: ",
          phone_fun(
            lawyer$phone
          )))),
    fpar(),
    fpar()
  )
}

heading <- c(heading, list(
  fpar(
    ftext(
      paste0(
        "RE:\t")),
    ftext(case_name, fp_text_lite(italic = TRUE))
  ),
  fpar(),
  fpar(),
  fpar(
    ftext(
      paste0(
        "Date of Crash:\t", 
        convert_date_format(
          crash$date
        ))))))

for (i in 1:length(plaintiff$first_name)) {
  heading <- c(heading,
               list(fpar(
                 ftext(
                   ifelse(i == 1, "Date of Birth:\t", "\t")),
                 ftext(paste0(
                   plaintiff$first_name[i],
                   " ",
                   plaintiff$last_name[i],
                   ": "),
                   prop = fp_text_lite(italic = TRUE)),
                 ftext(
                   convert_date_format(
                     plaintiff$dob[i]
                   )), 
                 ftext(" ["), ftext(plaintiff$age[i]), 
                 ftext(" years old at time of crash]")))
  )
}

heading <- c(heading, list(fpar(), fpar()))
```

```{r receipt}
receipt <- list(
  fpar(
    ftext(
      paste("Dear", Mr_Ms_Lastname(lawyer))
    ),
    ftext(",")
  ),
  fpar(),
  fpar(
    ftext(
      "I am in receipt of your correspondence regarding the above-named "),
    ftext(
      if (case == "yes") {
        "action"
      } else if (length(plaintiff$first_name) > 1) {
        "individuals"
      } else {
        "individual"
      }),
    ftext(
      ". I have reviewed the documentation accompanying your correspondence including medical records, information regarding the subject crash, litigation documents, and other materials"
    ),
    if (doc_type == "causation")
      ftext(
        "."
      ) else if (doc_type == "rebuttal") {
        ftext(
          paste0(
            ", including the ",
            if(defense_biomech_expert$depo_reviewed == "yes")
              paste0(
                convert_date_format(defense_biomech_expert$depo_date), 
                ", deposition transcript and the "),
            convert_date_format(defense_biomech_expert$report_date), 
            ", report from the defendant's crash reconstruction and biomechanical expert, ",
            defense_biomech_expert$title,
            " ",
            defense_biomech_expert$first_name,
            " ",
            defense_biomech_expert$last_name,
            "."
          ))}),
  fpar())
```

```{r purpose}
purpose <- list()
purpose$causation$rollover$part1 <- list(
  fpar(
    ftext(
      paste0(
        "The purpose of this report is to provide an opinion regarding the causal relationship between the degree of roof crush observed in the subject ", plaintiff$car_make, " ", plaintiff$car_model, " and the severe spine and spinal cord injuries sustained by ", Mr_Ms_Lastname(), " in the ", convert_date_format(crash$date), ", rollover crash. Specifically, my opinions address the theory of occupant \"diving\" in rollover crashes as the cause of serious head and neck injury, versus excessive roof crush. The methods and conclusions described in this report are largely based on peer-reviewed published research that I supervised and co-authored, specifically:"
      )
    )
    
  ),
  fpar()
)

purpose$causation$rollover$publications <- list(
  fpar(
    ftext(
      "Dobbertin KM, Freeman MD, Lambert WE, Lasarev MR, Kohles SS. The relationship between vehicle roof crush and head, neck and spine injury in rollover crashes. Accid Anal Prev 2013;58:46-52"
    )
  ),
  fpar(
    ftext(
      "Freeman MD, Dobbertin K, Kohles SS, Uhrenholt L, Eriksson A. Serious head and neck injury as a predictor of occupant position in fatal rollover crashes. Forensic Sci Int 2012;222:228–33."
    )
  ),
  fpar()
)

purpose$causation$rollover$part2 <- list(
  fpar(
    ftext(
      paste("The conclusions of the investigation described herein, as they apply to", Mr_Ms_Lastname(), "'s injuries and the subject crash, are described beginning on page 41 of this report.")
    )
  ),
  fpar()
)

purpose$causation$general <- list(
  fpar(
    ftext(
      paste0("The purpose of this report is to provide an analysis of the causal relationship between the subject ", crash$pdof, " impact collision and ", Mr_Ms_Lastname(), "’s subsequently diagnosed spinal injuries and need for treatment.")
    )
  ),
  fpar()
)

purpose$rebuttal <- list(
  fpar(
    ftext(
      paste0("The purpose of this report is to assess the methods and conclusions of ", Dr_Mr_Ms_Expert_Lastname(), " as they pertain to the injury potential of the subject collision, relative to ", Mr_Ms_Lastname(), "’s post-crash diagnoses and treatment.)"
      )
    )
  ),
  fpar()
)
```


```{r heading loop function call}
# style = "Normal": at least 16 pt line spacing; majority doc style
# style = "Body Text 2": Single line spacing and 3.75 tab distance
# style = "Author": block quote style indentation on both sides

doc %>%
  cursor_begin() %>% 
  body_remove() %>%
  # report section order has to be backwards because of how body_add() function works
  #block_add_fun(purpose$causation$general, style = "Normal") %>%
  block_add_fun(purpose$causation$rollover$part2, style = "Normal") %>%
  block_add_fun(purpose$causation$rollover$publications, style = "Author") %>%
  block_add_fun(purpose$causation$rollover$part1, style = "Normal") %>%
  block_add_fun(receipt) %>%
  block_add_fun(heading, style = "Body Text 2") %>%
  print(target = "../FRA-report-output.docx")
```



```{r sample footnote}
# working footnote structure
bl <- block_list(
  fpar(ftext(" hello"), fp_p = fp_par_footnote), 
  fpar(ftext(" second ref"), fp_p = fp_par_footnote),
  fpar(ftext(" second ref"), fp_p = fp_par_footnote)
)

footnote_fpar <- fpar(
  "this paragraph contains a note",
  run_footnote(x = bl[1], prop = fp_text_refnote),
  run_footnote(x = bl[2], prop = fp_text_refnote),
  run_footnote(x = bl[3], prop = fp_text_refnote),
  "."
)
```

```{r final build}
# Heading

# Lawyer address

# Intro paragraph

# The Purpose of this Report

# Summary Opinions (rebuttal)

# Qualifications

# Background Facts

# Medical History

# General Comments on Expert (rebuttal)

# Injury Biomechanics intro

# Injury Biomechanics body

# 3 steps alternative explanations (Causation)

# Rebuttal points

# Conclusions

# Signature Block

# Appendix

```
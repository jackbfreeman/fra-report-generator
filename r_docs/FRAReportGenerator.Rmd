---
title: "FR+A Report Generator"
output: 
  word_document:
    reference_docx: data/fra-template.docx
date: "2023-12-30"
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(magrittr)
library(officer)
library(officedown)
library(dplyr)
source("../r_docs/R/styles.R")
source("../r_docs/R/grammar.R")
source("../r_docs/R/variables.R")
source("../r_docs/R/footnotes.R")
source("../r_docs/R/header_replacement.R")
source("../r_docs/R/heading.R")
source("../r_docs/R/receipt.R")
source("../r_docs/R/purpose.R")
source("../r_docs/R/summary_opinions.R")
source("../r_docs/R/background_notes_med_hx.R")
source("../r_docs/R/general_comments.R")
# table for reading styles
styles_tab <- styles_info(doc)
```

```{r loop fpar add function}
block_add_fun <- function(x, blocklist, style = "Normal") {
  if (length(blocklist) == 0) {
    # If blocklist is empty, return x without further action
    return(x)
  }
  for (i in length(blocklist):1) {
    body_add(x, blocklist[[i]], style = style)
  }
  return(x)
}
```

## reference for replacing grammar in report language:

Mr_Ms_Lastname()/Firstname_Lastname() - defaults to plaintiff; otherwise
argument will be "defendant" or "lawyer" - includes all plaintiffs,
genders for single and naturalizes language for multiple

he_she()/He_She() him_her()/Him_Her() his_her()/His_Her() - defaults to
plaintiff; otherwise argument will be "defendant" or "lawyer"

single_plural() - argument ("in quotes") will be single if
length(plaintiff\$first_name) == 1, otherwise pluralize - pluralizes
verbs too (is, isn't, was, wasn't, has, hasn't)

```{r injury biomechanics intro}
inj_biomech <- list()

inj_biomech$intro$causation <- list(
  fpar(
    ftext(
      "Injury Causation Analysis", 
      prop = fp_text_lite(italic = TRUE, bold = TRUE))), 
  fpar(
    ftext(
      "A crash-related injury causation analysis for a specific individual is performed by assessing the risk of injury from the collision and comparing it to the probability that the injuries or conditions would have been present at the same point in time if the collision had not occurred. The process is referred to as a \"3-step\" injury causation method in which improbable alternative causes are ruled out and the single most likely cause is identified. The analysis is accomplished via the application of crash reconstruction, biomechanical, medical, and epidemiologic (risk assessment) principles."),
    run_footnote(x = footnotes_blocklist[1], prop = fp_text_refnote),
    run_footnote(x = footnotes_blocklist[2], prop = fp_text_refnote),
    run_footnote(x = footnotes_blocklist[3], prop = fp_text_refnote),
    ftext(" This 3-step methodology has been extensively described in the peer-reviewed literature, been deemed generally accepted by Courts in the United States, and has been adopted as part of case law in the U.S. -  See the Appendix at the end of this report for more information.")),
  fpar(),
  # must be rendered with style "Body Text 3" for inverted indentation
  fpar(
    ftext(
      "The three fundamental elements or steps of an injury causation analysis are as follows: 
Whether the injury mechanism had the potential to cause the injury in question (aka general causation);")),
fpar(
ftext("The degree of temporal proximity between the injury mechanism and the onset of the symptoms reasonably indicating the presence of the injury; and")),
fpar(
ftext("Whether there is a more likely alternative explanation for the occurrence of the symptoms at the same point in time (aka differential etiology).")),
fpar(),
fpar(
  ftext("As applied to the facts in the subject case, these 3 steps are as follows:")),
fpar(),
fpar(
  ftext("Reconstruction of the crash", prop = fp_text_lite(italic = TRUE))),
fpar((ftext("CRASH RECONSTRUCTION", prop = fp_text_lite(italic = TRUE, bold = TRUE)))),
fpar(),
fpar(ftext("Injury biomechanics", prop = fp_text_lite(italic = TRUE))))
```

```{r report structure build}
notes_structure <- as.list(
  c(heading,
    background_facts$notes))
```

```{r heading loop function call}
# style = "Normal": at least 16 pt line spacing; majority doc style
# style = "Body Text 2": Single line spacing and 3.75 tab distance
# style = "Author": block quote style indentation on both sides
# style = "Definition": bullet point in summary
# style = "Body Text 3": inverted indent in injury biomech section

doc %>%
  cursor_begin() %>% 
  body_remove() %>%
  # report section order has to be backwards because of how body_add() function works
  block_add_fun(inj_biomech$intro$causation) %>%
  block_add_fun(general_comments) %>%
  # block_add_fun(background_facts$notes) %>%
  # block_add_fun(qualifications$causation, style = "Normal") %>%
  # block_add_fun(summary_opinions, style = "Definition") %>%
  # block_add_fun(purpose$rebuttal, style = "Normal") %>%
  # block_add_fun(purpose$causation$general, style = "Normal") %>%
  # block_add_fun(purpose$causation$rollover$part2, style = "Normal") %>%
  # block_add_fun(purpose$causation$rollover$publications, style = "Author") %>%
  # block_add_fun(purpose$causation$rollover$part1, style = "Normal") %>%
  # block_add_fun(receipt) %>%
  # block_add_fun(heading, style = "Body Text 2") %>%
  # body_add(block_pour_docx(background_facts_recon_file_name)) %>%
# block_add_fun(notes_structure) %>%
print(target = "../FRA-report-output.docx")
```

```{r test remove}
# library(officer)
# 
# str1 <- rep("Lorem ipsum dolor sit amet, consectetur adipiscing elit. ", 20)
# str1 <- paste(str1, collapse = "")
# 
# str2 <- "Drop that text"
# 
# str3 <- rep("Aenean venenatis varius elit et fermentum vivamus vehicula. ", 20)
# str3 <- paste(str3, collapse = "")
# 
# my_doc <- read_docx()
# my_doc <- body_add_par(my_doc, value = str1, style = "Normal")
# my_doc <- body_add_par(my_doc, value = str2, style = "centered")
# my_doc <- body_add_par(my_doc, value = str3, style = "Normal")
# 
# new_doc_file <- print(my_doc, target = "one.docx")
# 
# my_doc <- read_docx(path = new_doc_file)
# my_doc <- cursor_reach(my_doc, keyword = "that text")
# my_doc <- body_remove(my_doc)
# 
# print(my_doc, target = "two.docx")
```

```{r final build}
# Heading

# Lawyer address

# Intro paragraph

# The Purpose of this Report

# Summary Opinions (rebuttal)

# Qualifications

# Background Facts

# Medical History

# General Comments on Expert (rebuttal)

# Injury Biomechanics intro

# Injury Biomechanics body

# 3 steps alternative explanations (Causation)

# Rebuttal points

# Conclusions

# Signature Block

# Appendix

```
